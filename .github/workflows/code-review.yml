name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    name: AI Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic PyGithub

      - name: Get PR diff
        id: get_diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt
          echo "Diff size: $(wc -c < pr_diff.txt) bytes"

      - name: Run Claude Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          REPO_NAME: ${{ github.repository }}
        run: |
          python << 'EOF'
          import os
          import sys
          import anthropic
          from github import Github, Auth

          # Check for API key
          api_key = os.environ.get("ANTHROPIC_API_KEY")
          if not api_key:
              print("ANTHROPIC_API_KEY not set. Skipping Claude code review.")
              print("To enable, add ANTHROPIC_API_KEY to repository secrets.")
              sys.exit(0)

          # Initialize clients
          client = anthropic.Anthropic(api_key=api_key)
          gh = Github(auth=Auth.Token(os.environ["GITHUB_TOKEN"]))

          # Get PR info
          repo = gh.get_repo(os.environ["REPO_NAME"])
          pr = repo.get_pull(int(os.environ["PR_NUMBER"]))
          pr_title = os.environ["PR_TITLE"]

          # Read diff
          with open("pr_diff.txt", "r") as f:
              diff = f.read()

          # Truncate if too large (Claude has context limits)
          max_diff_size = 50000
          if len(diff) > max_diff_size:
              diff = diff[:max_diff_size] + "\n\n... [diff truncated due to size]"

          # Create review prompt
          prompt = f"""You are a senior software engineer performing a code review. Review the following pull request and provide constructive feedback.

          PR Title: {pr_title}

          Changes (git diff):
          ```diff
          {diff}
          ```

          Please review this code and provide:
          1. **Summary**: Brief overview of what this PR does
          2. **Strengths**: What's done well
          3. **Suggestions**: Areas for improvement (be specific with file/line references when possible)
          4. **Security**: Any security concerns
          5. **Overall**: Approve, request changes, or comment

          Keep your review concise but thorough. Focus on:
          - Code quality and best practices
          - Potential bugs or edge cases
          - Security vulnerabilities
          - Performance considerations
          - Documentation and readability

          Format your response in markdown."""

          # Call Claude API
          message = client.messages.create(
              model="claude-sonnet-4-20250514",
              max_tokens=2048,
              messages=[
                  {"role": "user", "content": prompt}
              ]
          )

          review_content = message.content[0].text

          # Post review as PR comment
          comment_body = f"""## Claude Code Review

          {review_content}

          ---
          *Automated review by Claude AI*
          """

          pr.create_issue_comment(comment_body)
          print("Code review posted successfully!")
          EOF

      - name: Review posted
        run: echo "Claude code review has been posted to PR #${{ github.event.pull_request.number }}"
